<%# locals: (plaid_item:, plaid_accounts:) %>

<% if plaid_item.syncing? && plaid_accounts.empty? %>
  <div class="bg-container rounded-xl shadow-border-xs p-8 flex flex-col items-center gap-3">
    <%= icon "loader", size: "md", class: "animate-spin text-secondary" %>
    <p class="text-primary font-medium">Discovering accounts...</p>
    <p class="text-secondary text-sm">This may take a moment. The page will update automatically.</p>
  </div>
<% elsif plaid_accounts.any? %>
  <%= form_with url: import_accounts_plaid_item_path(plaid_item),
                method: :patch,
                data: { controller: "account-select" },
                class: "space-y-4" do |f| %>

    <div class="bg-container-inset rounded-xl p-1">
      <%# Header row %>
      <div class="grid grid-cols-12 items-center uppercase text-xs font-medium text-secondary px-4 py-2">
        <div class="col-span-5 flex items-center gap-2">
          <input type="checkbox"
                 class="checkbox checkbox--light"
                 data-account-select-target="selectAll"
                 data-action="account-select#toggleAll">
          <span>Account</span>
        </div>
        <p class="col-span-2 justify-self-end">Type</p>
        <p class="col-span-2 justify-self-end">Currency</p>
        <p class="col-span-3 justify-self-end">Balance</p>
      </div>

      <%# Account rows %>
      <div class="bg-container rounded-lg shadow-border-xs divide-y divide-primary">
        <% plaid_accounts.each_with_index do |plaid_account, index| %>
          <% imported = plaid_account.account.present? %>

          <div class="grid grid-cols-12 items-center px-4 py-3">
            <input type="hidden" name="plaid_accounts[<%= index %>][id]" value="<%= plaid_account.id %>">

            <%# Checkbox + Name (col-span-5) %>
            <div class="col-span-5 flex items-center gap-2 min-w-0">
              <% if imported %>
                <input type="hidden" name="plaid_accounts[<%= index %>][selected]" value="1">
              <% end %>
              <input type="checkbox"
                     name="plaid_accounts[<%= index %>][selected]"
                     value="1"
                     class="checkbox checkbox--light shrink-0"
                     <%= "checked" if plaid_account.selected_for_import? || !imported %>
                     <%= "disabled" if imported %>
                     data-account-select-target="row"
                     data-action="account-select#toggleRow">

              <div class="flex items-center gap-2 min-w-0">
                <input type="text"
                       name="plaid_accounts[<%= index %>][custom_name]"
                       value="<%= plaid_account.custom_name.presence || plaid_account.name %>"
                       placeholder="<%= plaid_account.name %>"
                       class="form-field__input text-sm py-1 min-w-0"
                       autocomplete="off"
                       <%= "disabled" if imported %>>

                <% if imported %>
                  <span class="inline-flex items-center gap-1 text-xs font-medium text-green-700 bg-green-50 rounded-full px-2 py-0.5 whitespace-nowrap">
                    <%= icon "check-circle", size: "xs" %>
                    Imported
                  </span>
                <% end %>
              </div>
            </div>

            <%# Type (col-span-2) %>
            <div class="col-span-2 justify-self-end">
              <% if plaid_account.plaid_type.present? %>
                <span class="inline-flex items-center gap-1 text-xs text-secondary bg-container-inset rounded-full px-2 py-0.5">
                  <%= plaid_account.plaid_type %>
                </span>
              <% end %>
            </div>

            <%# Currency (col-span-2) %>
            <p class="col-span-2 justify-self-end text-sm text-secondary">
              <%= plaid_account.currency %>
            </p>

            <%# Balance (col-span-3) %>
            <p class="col-span-3 justify-self-end text-sm font-medium text-primary">
              <% balance = plaid_account.current_balance || plaid_account.available_balance %>
              <% if balance.present? && balance > 0 %>
                <%= number_to_currency(balance, unit: plaid_account.currency == "CAD" ? "$" : plaid_account.currency + " ") %>
              <% else %>
                &mdash;
              <% end %>
            </p>
          </div>
        <% end %>
      </div>
    </div>

    <div class="flex items-center justify-between">
      <%= link_to "Skip for now", accounts_path, class: "text-sm text-secondary hover:text-primary" %>

      <div class="flex items-center gap-3">
        <span class="text-sm text-secondary" data-account-select-target="count"></span>

        <button type="submit" class="btn btn--primary inline-flex items-center gap-2">
          <%= icon "download", size: "sm" %>
          Import Selected
        </button>
      </div>
    </div>
  <% end %>
<% else %>
  <div class="bg-container rounded-xl shadow-border-xs p-8 flex flex-col items-center gap-3">
    <p class="text-primary font-medium">No accounts found</p>
    <p class="text-secondary text-sm">No accounts were discovered for this connection.</p>
    <div class="flex items-center gap-3 mt-2">
      <%= link_to "Back to accounts", accounts_path, class: "text-sm text-secondary hover:text-primary" %>
      <%= link_to "Retry sync", sync_plaid_item_path(plaid_item), data: { turbo_method: :post }, class: "text-sm text-primary font-medium hover:underline" %>
    </div>
  </div>
<% end %>
