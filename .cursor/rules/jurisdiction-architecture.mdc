---
description: Multi-jurisdiction architecture patterns - Canadian-first, globally-extensible design
globs:
  - "**/{models,services,concerns}/**/*.rb"
  - "db/seeds/**/*.rb"
alwaysApply: false
---

# Multi-Jurisdiction Architecture

This rule enforces jurisdiction-aware design patterns for Canadian-first, globally-extensible architecture.

## Core Principle: Canadian-First, Globally-Extensible

**Primary Market**: Canadian users (80%+ of content and examples)

**Design Philosophy**: Build for Canada today, architect for global expansion tomorrow.

**Implementation Strategy**:
- Phase 1-4: Build with Canadian defaults (PAG 2025, CRA tax rules, Smith Manoeuvre)
- Phase 5+: Add US/UK/EU via configuration (no refactoring required)

## Visual Markers in Code

Use these markers consistently in comments:

- ğŸ‡¨ğŸ‡¦ **Canadian-specific** - Implementation details specific to Canada
- ğŸŒ **Universal** - Concepts that apply globally
- ğŸ”§ **Extensibility hook** - Architectural patterns designed for future jurisdictions
- ğŸ‡ºğŸ‡¸ **Future: US** - Commented examples showing how US support would be added
- ğŸ‡¬ğŸ‡§ **Future: UK** - Commented examples showing how UK support would be added

**Example**:
```ruby
# ğŸ‡¨ğŸ‡¦ Canadian Modified Smith Manoeuvre simulator
class CanadianSmithManoeuvrSimulator
  # CRA-compliant debt optimization
end

# ğŸ”§ Extensibility: Future US simulator would follow same pattern
# ğŸ‡ºğŸ‡¸ class UsHelocArbitrageSimulator
#   # IRS-compliant HELOC strategies
# end
```

---

## Jurisdiction Configuration Pattern

### Rule: ALL tax/compliance features MUST support jurisdictions

**Database Schema** (REQUIRED):
```ruby
# All relevant tables have jurisdiction_id (optional, defaults to Canada)
create_table :families do |t|
  t.references :jurisdiction, type: :uuid, foreign_key: true, null: true
  # null: true allows default to Canada
end

create_table :debt_optimization_strategies do |t|
  t.references :family, null: false, foreign_key: true
  t.references :jurisdiction, type: :uuid, foreign_key: true, null: true
  t.references :tax_calculator_config, foreign_key: true
  # ...
end

create_table :projection_standards do |t|
  t.references :jurisdiction, type: :uuid, foreign_key: true, null: false
  t.integer :standard_type  # pag_2025, cfp_board_2025, iso_guidance
  t.jsonb :asset_assumptions
  # ...
end
```

### Jurisdiction Model Pattern (Actual Implementation)

```ruby
# app/models/jurisdiction.rb ğŸ”§
# ğŸ‡¨ğŸ‡¦ Canadian-first jurisdiction registry
# ğŸ”§ Extensibility: Architecture supports future US/UK expansion
class Jurisdiction < ApplicationRecord
  has_many :projection_standards, dependent: :destroy

  validates :country_code, presence: true, uniqueness: true
  validates :name, presence: true
  validates :currency_code, presence: true

  # Database columns:
  # - country_code: "CA", "US", "GB"
  # - name: "Canada", "United States"
  # - currency_code: "CAD", "USD"
  # - interest_deductible: boolean (Canadian tax rules)
  # - has_smith_manoeuvre: boolean (Canadian strategy availability)
  # - tax_config: jsonb (tax brackets and rates)

  scope :canada, -> { find_by(country_code: "CA") }
  scope :active, -> { all }

  # ğŸ‡¨ğŸ‡¦ Canadian tax-specific helper
  def interest_deductible?
    interest_deductible
  end

  # ğŸ‡¨ğŸ‡¦ Smith Manoeuvre availability
  def supports_smith_manoeuvre?
    has_smith_manoeuvre
  end

  # Get current projection standard (e.g., PAG 2025)
  def current_projection_standard
    projection_standards.order(effective_year: :desc).first
  end

  # Calculate marginal tax rate from stored brackets
  def marginal_tax_rate(income:)
    brackets = tax_config["brackets"] || []
    return 0 if brackets.empty?

    applicable_rate = 0
    brackets.each do |bracket|
      if income > bracket["min"]
        applicable_rate = bracket["rate"]
      end
    end

    applicable_rate.to_d
  end

  class << self
    def default
      find_by(country_code: "CA") || first
    end

    def for_country(code)
      find_by(country_code: code.to_s.upcase)
    end
  end
end
```

### JurisdictionAware Concern (Actual Implementation)

```ruby
# app/models/concerns/jurisdiction_aware.rb ğŸ”§
# ğŸ‡¨ğŸ‡¦ JurisdictionAware concern for jurisdiction-specific behavior
# ğŸ”§ Extensibility: Supports future US/UK expansion
module JurisdictionAware
  extend ActiveSupport::Concern

  # Get the jurisdiction for this model
  def jurisdiction
    country_code = determine_country_code
    @jurisdiction ||= Jurisdiction.for_country(country_code) || Jurisdiction.default
  end

  # Get the projection standard for this jurisdiction
  def projection_standard
    jurisdiction&.current_projection_standard
  end

  # Get tax calculator config for this jurisdiction
  def tax_calculator_config
    jurisdiction&.tax_config || {}
  end

  # Calculate marginal tax rate based on jurisdiction
  def marginal_tax_rate(income:)
    jurisdiction&.marginal_tax_rate(income: income) || 0
  end

  # ğŸ‡¨ğŸ‡¦ Check if interest is tax deductible in this jurisdiction
  def interest_deductible?
    jurisdiction&.interest_deductible? || false
  end

  # ğŸ‡¨ğŸ‡¦ Check if Smith Manoeuvre is available
  def supports_smith_manoeuvre?
    jurisdiction&.supports_smith_manoeuvre? || false
  end

  # Get currency for this jurisdiction
  def jurisdiction_currency
    jurisdiction&.currency_code || "USD"
  end

  private

  def determine_country_code
    return country if respond_to?(:country) && country.present?
    return family.country if respond_to?(:family) && family&.country.present?
    "CA" # ğŸ‡¨ğŸ‡¦ Default to Canada
  end
end
```

---

## Tax Rules as Configuration (NEVER Hardcode)

### TaxCalculatorConfig Pattern

```ruby
# app/models/tax_calculator_config.rb ğŸ”§
class TaxCalculatorConfig < ApplicationRecord
  belongs_to :jurisdiction

  string :authority_name  # "CRA" ğŸ‡¨ğŸ‡¦, "IRS" ğŸ‡ºğŸ‡¸, "HMRC" ğŸ‡¬ğŸ‡§

  # Tax brackets by jurisdiction (stored as JSONB)
  jsonb :federal_brackets
  # Example for Canada ğŸ‡¨ğŸ‡¦:
  # {
  #   "2025": [
  #     { "max": 55867, "rate": 0.15 },
  #     { "max": 111733, "rate": 0.205 },
  #     { "max": 173205, "rate": 0.26 },
  #     { "max": 246752, "rate": 0.29 },
  #     { "max": null, "rate": 0.33 }
  #   ]
  # }

  jsonb :provincial_state_brackets
  # Example for Ontario ğŸ‡¨ğŸ‡¦:
  # {
  #   "ON": {
  #     "2025": [
  #       { "max": 51446, "rate": 0.0505 },
  #       { "max": 102894, "rate": 0.0915 },
  #       { "max": 150000, "rate": 0.1116 },
  #       { "max": 220000, "rate": 0.1216 },
  #       { "max": null, "rate": 0.1316 }
  #     ]
  #   }
  # }

  # Deductibility rules (jurisdiction-specific)
  jsonb :deductibility_rules
  # Example for Canada ğŸ‡¨ğŸ‡¦:
  # {
  #   "rental_mortgage_interest": true,
  #   "heloc_for_rental_expenses": true,
  #   "primary_mortgage_interest": false,  # ğŸ‡¨ğŸ‡¦ Not deductible in Canada
  #   "investment_loan_interest": true
  # }
  # Example for US ğŸ‡ºğŸ‡¸ (Future):
  # {
  #   "rental_mortgage_interest": true,
  #   "heloc_interest": true,  # But capped at $100K principal
  #   "primary_mortgage_interest": true,  # ğŸ‡ºğŸ‡¸ Deductible in US
  #   "investment_loan_interest": true
  # }

  boolean :requires_purpose_tracking  # true for CRA ğŸ‡¨ğŸ‡¦, IRS ğŸ‡ºğŸ‡¸
  string :compliance_report_template  # Path to jurisdiction-specific template

  # Calculate marginal tax rate for a given income
  def marginal_tax_rate(income:, province_or_state: nil)
    federal_rate = calculate_bracket_rate(income, federal_brackets.dig("2025"))
    provincial_rate = 0

    if province_or_state && provincial_state_brackets.key?(province_or_state)
      provincial_rate = calculate_bracket_rate(
        income,
        provincial_state_brackets.dig(province_or_state, "2025")
      )
    end

    federal_rate + provincial_rate
  end

  private

  def calculate_bracket_rate(income, brackets)
    brackets.each do |bracket|
      return bracket["rate"] if bracket["max"].nil? || income <= bracket["max"]
    end
    brackets.last["rate"]  # Highest bracket
  end
end
```

### Seed Data for Canadian Tax Rules

```ruby
# db/seeds/canadian_tax_rules.rb ğŸ‡¨ğŸ‡¦
module Seeds
  class CanadianTaxRules
    def self.seed
      canada = Jurisdiction.find_or_create_by!(country_code: 'CA') do |j|
        j.country_name = 'Canada'
        j.active = true
      end

      TaxCalculatorConfig.find_or_create_by!(jurisdiction: canada) do |config|
        config.authority_name = 'CRA'
        config.requires_purpose_tracking = true
        config.compliance_report_template = 'tax_reports/cra_template'

        # ğŸ‡¨ğŸ‡¦ 2025 Federal tax brackets
        config.federal_brackets = {
          "2025" => [
            { "max" => 55867, "rate" => 0.15 },
            { "max" => 111733, "rate" => 0.205 },
            { "max" => 173205, "rate" => 0.26 },
            { "max" => 246752, "rate" => 0.29 },
            { "max" => nil, "rate" => 0.33 }
          ]
        }

        # ğŸ‡¨ğŸ‡¦ Provincial brackets (Ontario example)
        config.provincial_state_brackets = {
          "ON" => {
            "2025" => [
              { "max" => 51446, "rate" => 0.0505 },
              { "max" => 102894, "rate" => 0.0915 },
              { "max" => 150000, "rate" => 0.1116 },
              { "max" => 220000, "rate" => 0.1216 },
              { "max" => nil, "rate" => 0.1316 }
            ]
          }
        }

        # ğŸ‡¨ğŸ‡¦ CRA deductibility rules
        config.deductibility_rules = {
          "rental_mortgage_interest" => true,
          "heloc_for_rental_expenses" => true,
          "primary_mortgage_interest" => false,  # Not deductible in Canada
          "investment_loan_interest" => true
        }
      end
    end
  end
end
```

---

## Projection Standards as Configuration

### ProjectionStandard Model

```ruby
# app/models/projection_standard.rb ğŸ”§
class ProjectionStandard < ApplicationRecord
  belongs_to :jurisdiction

  enum standard_type: {
    pag_2025: 0,        # ğŸ‡¨ğŸ‡¦ FP Canada
    cfp_board_2025: 1,  # ğŸ‡ºğŸ‡¸ Future
    iso_guidance: 2,    # ğŸŒ Future
    custom: 3
  }

  jsonb :asset_assumptions  # Allows different asset classes per standard
  string :compliance_badge_text
  boolean :active, default: true
  date :published_date

  # ğŸ‡¨ğŸ‡¦ PAG 2025 default values (Canadian implementation)
  PAG_2025_DEFAULTS = {
    canadian_equity: { nominal: 0.066, volatility: 0.157, real: 0.045 },
    us_equity: { nominal: 0.066, volatility: 0.161, real: 0.045 },
    intl_developed_equity: { nominal: 0.069, volatility: 0.193, real: 0.048 },
    emerging_market_equity: { nominal: 0.080, volatility: 0.239, real: 0.059 },
    fixed_income: { nominal: 0.034, volatility: 0.078, real: 0.013 },
    short_term: { nominal: 0.024, volatility: 0.046, real: 0.003 }
  }.freeze
end
```

### Seed Data for PAG 2025

```ruby
# db/seeds/canadian_projection_standards.rb ğŸ‡¨ğŸ‡¦
module Seeds
  class CanadianProjectionStandards
    def self.seed
      canada = Jurisdiction.find_by(country_code: 'CA')

      pag_2025 = ProjectionStandard.find_or_create_by!(
        jurisdiction: canada,
        standard_type: :pag_2025
      ) do |standard|
        standard.compliance_badge_text = "Prepared using FP Canada PAG 2025"
        standard.active = true
        standard.published_date = Date.new(2024, 12, 1)
        standard.asset_assumptions = ProjectionStandard::PAG_2025_DEFAULTS
      end

      # Set as default for Canada
      canada.update!(default_projection_standard: pag_2025)
    end
  end
end
```

---

## Strategy Simulators as Pluggable Classes

### Enum includes jurisdiction-specific strategies

```ruby
# app/models/debt_optimization_strategy.rb ğŸ”§
class DebtOptimizationStrategy < ApplicationRecord
  include JurisdictionAware

  belongs_to :family
  belongs_to :jurisdiction, optional: true
  belongs_to :tax_calculator_config

  enum strategy_type: {
    baseline: 0,          # ğŸŒ Universal: no optimization
    modified_smith: 1,    # ğŸ‡¨ğŸ‡¦ Canadian Smith Manoeuvre
    heloc_arbitrage: 2,   # ğŸ‡ºğŸ‡¸ Future: US HELOC strategies
    offset_mortgage: 3,   # ğŸ‡¬ğŸ‡§ Future: UK offset mortgages
    custom: 4
  }

  # Validate strategy is available for jurisdiction
  validate :strategy_available_for_jurisdiction

  # ğŸ”§ Factory pattern: return appropriate simulator class
  def simulator
    case strategy_type
    when 'modified_smith'
      CanadianSmithManoeuvrSimulator.new(self)  # ğŸ‡¨ğŸ‡¦
    when 'heloc_arbitrage'
      UsHelocArbitrageSimulator.new(self)       # ğŸ‡ºğŸ‡¸ Future
    when 'offset_mortgage'
      UkOffsetMortgageSimulator.new(self)       # ğŸ‡¬ğŸ‡§ Future
    else
      BaselineSimulator.new(self)               # ğŸŒ Universal
    end
  end

  def simulate(months:)
    simulator.run(months: months)
  end

  private

  def strategy_available_for_jurisdiction
    available = jurisdiction.available_debt_optimization_strategies
    unless available.include?(strategy_type.to_sym)
      errors.add(:strategy_type, "not available for #{jurisdiction.country_name}")
    end
  end
end
```

### Canadian Simulator Example

```ruby
# app/services/canadian_smith_manoeuvre_simulator.rb ğŸ‡¨ğŸ‡¦
class CanadianSmithManoeuvrSimulator
  def initialize(strategy)
    @strategy = strategy
    @tax_config = strategy.jurisdiction.tax_calculator_config
  end

  def run(months:)
    # Validate CRA compliance requirements
    validate_cra_requirements

    results = {
      baseline: simulate_baseline(months),
      modified: simulate_modified_smith(months)
    }

    # Return comparison with CRA-compliant audit trail
    {
      baseline_total_interest: results[:baseline][:total_interest],
      modified_total_interest: results[:modified][:total_interest],
      tax_benefit: results[:modified][:tax_benefit],
      net_savings: calculate_net_savings(results),
      month_by_month: results[:modified][:ledger],
      cra_audit_trail: generate_cra_audit_trail(results[:modified])  # ğŸ‡¨ğŸ‡¦
    }
  end

  private

  def simulate_modified_smith(months)
    ledger = []

    months.times do |month|
      entry = {}

      # ğŸ‡¨ğŸ‡¦ Rental income â†’ primary mortgage prepayment (non-deductible per CRA)
      entry[:rental_income] = @strategy.rental_income_monthly
      entry[:primary_prepayment] = @strategy.rental_income_monthly

      # ğŸ‡¨ğŸ‡¦ HELOC â†’ rental expenses (deductible per CRA)
      heloc_draw = @strategy.rental_expenses_monthly
      entry[:heloc_draw] = heloc_draw
      entry[:heloc_balance] += heloc_draw

      # ğŸ‡¨ğŸ‡¦ HELOC interest (tax deductible per CRA rules)
      heloc_interest = entry[:heloc_balance] * (@strategy.heloc.interest_rate / 12)
      entry[:heloc_interest] = heloc_interest
      entry[:tax_refund] = heloc_interest * @strategy.marginal_tax_rate

      # Validate CRA compliance
      validate_cra_compliance(entry)

      ledger << entry
    end

    ledger
  end

  def validate_cra_requirements
    # CRA requires HELOC to be used exclusively for rental expenses
    unless @tax_config.deductibility_rules["heloc_for_rental_expenses"]
      raise "HELOC interest not deductible in this jurisdiction"
    end
  end

  def validate_cra_compliance(entry)
    # Check: HELOC used exclusively for rental (CRA requirement)
    # This validation is specific to Canadian tax law
  end

  def generate_cra_audit_trail(results)
    # Generate CRA-specific compliance report
    # See DESIGN_VISION.md Part 2.3 for details
  end
end
```

---

## Provider Pattern Alignment

This architecture **leverages the existing Provider pattern** already in Maybe Finance:

```ruby
# Existing pattern in Maybe Finance (app/models/provider/)
Provider::Registry.get_provider(:synth)  # ğŸŒ Market data provider
Provider::Registry.get_provider(:plaid)  # ğŸŒ Bank connectivity provider

# Extended for jurisdictions ğŸ”§
Jurisdiction.find_by(country_code: 'CA')  # ğŸ‡¨ğŸ‡¦ Canada jurisdiction
  â†’ .projection_standard                   # PAG 2025
  â†’ .tax_calculator_config                 # CRA rules
  â†’ .available_strategies                  # Modified Smith Manoeuvre

Jurisdiction.find_by(country_code: 'US')  # ğŸ‡ºğŸ‡¸ Future: US jurisdiction
  â†’ .projection_standard                   # CFP Board standards
  â†’ .tax_calculator_config                 # IRS rules
  â†’ .available_strategies                  # HELOC arbitrage
```

**Benefits**:
- Consistent with existing codebase patterns
- Add new countries via seed data (no code changes)
- User families can have jurisdiction association
- Default to Canadian rules (primary market)

---

## Migration Pattern

When adding jurisdiction support to existing tables:

```ruby
class AddJurisdictionSupport < ActiveRecord::Migration[7.2]
  def change
    # Create jurisdictions table ğŸ”§
    create_table :jurisdictions, id: :uuid do |t|
      t.string :country_code, null: false
      t.string :country_name, null: false
      t.boolean :active, default: true
      t.timestamps
    end

    add_index :jurisdictions, :country_code, unique: true

    # Create tax calculator configs ğŸ”§
    create_table :tax_calculator_configs, id: :uuid do |t|
      t.references :jurisdiction, type: :uuid, null: false, foreign_key: true
      t.string :authority_name, null: false
      t.jsonb :federal_brackets, default: {}
      t.jsonb :provincial_state_brackets, default: {}
      t.jsonb :deductibility_rules, default: {}
      t.boolean :requires_purpose_tracking, default: false
      t.string :compliance_report_template
      t.timestamps
    end

    # Add jurisdiction to families (optional, defaults to Canada)
    add_reference :families, :jurisdiction, type: :uuid, foreign_key: true, null: true

    # Seed Canadian jurisdiction as default
    reversible do |dir|
      dir.up do
        execute <<-SQL
          INSERT INTO jurisdictions (id, country_code, country_name, active, created_at, updated_at)
          VALUES (gen_random_uuid(), 'CA', 'Canada', true, NOW(), NOW())
        SQL
      end
    end
  end
end
```

---

## Anti-Patterns

**âŒ DON'T hardcode tax rules**:
```ruby
# BAD
def calculate_tax_benefit(interest)
  # Hardcoded Canadian marginal rate
  interest * 0.45
end
```

**âœ… DO use jurisdiction configuration**:
```ruby
# GOOD
def calculate_tax_benefit(interest)
  marginal_rate = tax_calculator_config.marginal_tax_rate(
    income: family.annual_income,
    province_or_state: family.province
  )
  interest * marginal_rate
end
```

**âŒ DON'T check jurisdiction in every method**:
```ruby
# BAD
def calculate_deduction
  if jurisdiction.country_code == 'CA'
    # Canadian logic
  elsif jurisdiction.country_code == 'US'
    # US logic
  end
end
```

**âœ… DO use pluggable simulators**:
```ruby
# GOOD
strategy.simulator.run(months: 360)  # Factory pattern selects correct simulator
```

---

## Testing Jurisdiction Patterns

```ruby
# test/models/jurisdiction_test.rb
class JurisdictionTest < ActiveSupport::TestCase
  test "default jurisdiction is Canada" do
    assert_equal 'CA', Jurisdiction.default.country_code
  end

  test "Canadian jurisdiction has PAG 2025 standard" do
    canada = jurisdictions(:canada)
    assert_equal :pag_2025, canada.default_projection_standard.standard_type
  end

  test "Canadian jurisdiction supports modified smith strategy" do
    canada = jurisdictions(:canada)
    assert_includes canada.available_debt_optimization_strategies, :modified_smith
  end
end

# test/models/debt_optimization_strategy_test.rb
class DebtOptimizationStrategyTest < ActiveSupport::TestCase
  test "defaults to Canadian jurisdiction" do
    strategy = DebtOptimizationStrategy.create!(
      family: families(:canadian_family),
      strategy_type: :modified_smith
    )
    assert_equal 'CA', strategy.jurisdiction.country_code
  end

  test "validates strategy available for jurisdiction" do
    us_jurisdiction = jurisdictions(:united_states)
    strategy = DebtOptimizationStrategy.new(
      family: families(:us_family),
      jurisdiction: us_jurisdiction,
      strategy_type: :modified_smith  # Not available in US
    )
    assert_not strategy.valid?
    assert_includes strategy.errors[:strategy_type], "not available for United States"
  end
end
```

---

## Implementation Status

| Component | Status | Location |
|-----------|--------|----------|
| Jurisdiction model | âœ… Complete | `app/models/jurisdiction.rb` |
| ProjectionStandard model | âœ… Complete | `app/models/projection_standard.rb` |
| JurisdictionAware concern | âœ… Complete | `app/models/concerns/jurisdiction_aware.rb` |
| **Account integration** | âœ… Complete | `app/models/account.rb` - includes JurisdictionAware |
| **Family integration** | âœ… Complete | `app/models/family.rb` - includes JurisdictionAware |
| Canada seed data | âœ… Complete | `db/seeds/jurisdictions.rb` |
| PAG 2025 seed data | âœ… Complete | `db/seeds/projection_standards.rb` |
| TaxCalculatorConfig model | â³ Phase 3 | Part of debt optimization |
| DebtOptimizationStrategy model | â³ Phase 3 | Pending |
| US jurisdiction support | â³ Phase 5+ | Future |
| UK jurisdiction support | â³ Phase 5+ | Future |

---

## References

- See DESIGN_VISION.md Part 0 for multi-jurisdiction philosophy
- See DESIGN_VISION.md Part 2.2 for strategy simulator patterns
- See DESIGN_VISION.md Part 8 for jurisdiction configuration guide
