---
description: Core data model deep dive — accountables, entries, syncs, providers, balances
globs:
  - "app/models/**/*.rb"
  - "app/models/concerns/**/*.rb"
alwaysApply: false
---

# Core Data Model Deep Dive

This rule provides detailed documentation of the core domain models beyond what CLAUDE.md covers. For an authoritative overview of all relationships, [schema.rb](mdc:db/schema.rb) is the source of truth.

---

## Accountables (Delegated Types)

[account.rb](mdc:app/models/account.rb) is a Rails "delegated type" with the following subtypes (separate DB tables). Each account has a `classification` of either `asset` or `liability`:

### Asset Accountables
- [depository.rb](mdc:app/models/depository.rb) — typical "bank account" (savings, checking)
- [investment.rb](mdc:app/models/investment.rb) — account with "holdings" (brokerage, 401k, RRSP, TFSA)
- [crypto.rb](mdc:app/models/crypto.rb) — tracks value of one or more crypto holdings
- [property.rb](mdc:app/models/property.rb) — tracks value of physical property (house, rental)
- [vehicle.rb](mdc:app/models/vehicle.rb) — tracks value of a vehicle
- [other_asset.rb](mdc:app/models/other_asset.rb) — asset that doesn't fit other types (e.g. jewelry)

### Liability Accountables
- [credit_card.rb](mdc:app/models/credit_card.rb) — tracks debt owed on a credit card
- [loan.rb](mdc:app/models/loan.rb) — tracks debt on a loan (mortgage, student loan, HELOC)
- [other_liability.rb](mdc:app/models/other_liability.rb) — liability that doesn't fit other types (e.g. IOU)

---

## Account Balances

An account [balance.rb](mdc:app/models/balance.rb) represents a single balance value for an account on a specific `date`. A series of balance records is generated daily for each account and powers historical balance graphs.

- **Simple accounts** (e.g. Checking): balance = amount of cash on that date
- **Complex accounts** (e.g. Investment Brokerage): balance = cash balance + holdings value
- For `asset` classification: balance = "How much the account is worth"
- For `liability` classification: balance = "How much is owed on the account"

All balances are calculated daily by [forward_calculator.rb](mdc:app/models/balance/forward_calculator.rb) (or [reverse_calculator.rb](mdc:app/models/balance/reverse_calculator.rb) for certain account types).

---

## Account Holdings

An account [holding.rb](mdc:app/models/holding.rb) applies to [investment.rb](mdc:app/models/investment.rb) type accounts and represents a `qty` of a certain [security.rb](mdc:app/models/security.rb) at a specific `price` on a specific `date`.

For investment accounts with holdings, [forward_calculator.rb](mdc:app/models/holding/forward_calculator.rb) (and [reverse_calculator.rb](mdc:app/models/holding/reverse_calculator.rb)) calculate daily historical holding quantities and prices, which are rolled up into a final "Balance" for the account in [base_calculator.rb](mdc:app/models/balance/base_calculator.rb).

---

## Account Entries (Delegated Type)

An account [entry.rb](mdc:app/models/entry.rb) is a Rails "delegated type". `Entry` represents any record that _modifies_ an Account's balance and/or holdings. Every entry must have a `date`, `amount`, and `currency`.

### Signed Amount Convention (CRITICAL)

The `amount` of an [entry.rb](mdc:app/models/entry.rb) is a **signed value**:
- **Negative amount** = "inflow" of money to that account
- **Positive amount** = "outflow" of money from that account

Examples:
- Negative amount on a **credit card** = a "payment" that _reduces_ its balance (liability decreases)
- Negative amount on a **checking account** = "income" that _increases_ its balance (asset increases)
- Negative amount on an **investment trade** = a "sell" that _increases_ cash balance

### Entry Types ([entryable.rb](mdc:app/models/entryable.rb))

1. **`Valuation`** ([valuation.rb](mdc:app/models/valuation.rb)) — absolute measure of account value on a date. If there's a Valuation of 5,000 for today, the account balance will be 5,000 today.
2. **`Transaction`** ([transaction.rb](mdc:app/models/transaction.rb)) — alters account balance by the amount. Most common entry type (income/expense).
3. **`Trade`** ([trade.rb](mdc:app/models/trade.rb)) — investment account only. Represents a "buy" or "sell" of a holding with `qty` and `price`.

---

## Account Transfers

A [transfer.rb](mdc:app/models/transfer.rb) represents movement of money between two accounts. A transfer has an inflow Transaction and an outflow Transaction. The system auto-matches transfers based on:

- Must be from different accounts
- Must be within 4 days of each other
- Must be the same currency
- Must be opposite values

### Transfer Types
- **Regular transfer** — normal movement between accounts (e.g. Checking → Brokerage). Typically _excluded_ from income/expense calculations.
- **Debt payment** — receiver is a [loan.rb](mdc:app/models/loan.rb) type account. Considered an "expense".

---

## Account Connectivity Providers

### Plaid Items (Banking)

A [plaid_item.rb](mdc:app/models/plaid_item.rb) represents a "connection" maintained by Plaid. An Item has 1+ [plaid_account.rb](mdc:app/models/plaid_account.rb) records, each associated 1:1 with an internal [account.rb](mdc:app/models/account.rb).

Plaid handles banking account types: chequing, savings, credit cards, loans. Supports US and EU regions.

**Account selection flow**: After Plaid Link OAuth, discovered accounts are shown on a review page. Users select which accounts to import (`selected_for_import` flag) and optionally rename them (`custom_name`). Only selected accounts are synced.

All Plaid metadata is stored on PlaidItem and PlaidAccount; "normalized" data lives on internal domain models.

### SnapTrade Connections (Brokerage)

A [snaptrade_connection.rb](mdc:app/models/snaptrade_connection.rb) represents a brokerage connection via SnapTrade. A connection has 1+ [snaptrade_account.rb](mdc:app/models/snaptrade_account.rb) records, each linked 1:1 to an internal [account.rb](mdc:app/models/account.rb).

SnapTrade handles investment brokerage types: Investment, Crypto. Primarily used for Canadian brokerages (Wealthsimple, Questrade, etc.).

**Account selection flow**: After OAuth, discovered accounts are shown on a review page. Users select which accounts to import (`selected_for_import` flag) and optionally rename them (`custom_name`). Only selected accounts are synced.

**Connection lifecycle**: On destroy, `remove_connection` is called on SnapTrade API, and if no connections remain, the family's SnapTrade user is deregistered.

**Provider routing**: [accountable_resource.rb](mdc:app/controllers/concerns/accountable_resource.rb) `set_link_options` routes brokerage types (Investment, Crypto) to SnapTrade; banking types to Plaid.

### Sync Architecture ([syncable.rb](mdc:app/models/concerns/syncable.rb))

"Syncables" — models that can have data synced in the background:

- **Account sync** — syncs holdings, balances, enhances transaction metadata. Orchestrated by `sync_data`. Triggered every time an Entry is updated.
- **PlaidItem sync** — ETL operation: (1) fetch from Plaid API, (2) load to PlaidAccount records (only `selected_for_import` ones), (3) transform/load to internal Account and Entry models.
- **SnapTradeConnection sync** — ETL operation: (1) fetch from SnapTrade API, (2) load to SnapTradeAccount records (only `selected_for_import` ones), (3) process positions and activities into Holdings and Entries.
- **Family sync** — orchestrator that loops through PlaidItems, SnapTradeConnections, and Accounts. Runs once daily via [auto_sync.rb](mdc:app/controllers/concerns/auto_sync.rb).

Each sync creates a [sync.rb](mdc:app/models/sync.rb) record tracking status, errors, and audit data.

---

## Data Providers

The app uses 3rd party data services for historical balances, data enrichment, and more. Providers are _optional_ for self-hosted users and configured at runtime through [registry.rb](mdc:app/models/provider/registry.rb) using [setting.rb](mdc:app/models/setting.rb).

### "Concept" Data (Swappable Providers)

Generic data where providers can be swapped. Each concept has an interface in `app/models/provider/concepts/`:

```
app/models/
  exchange_rate/
    provided.rb             # Selects the concept provider from the registry
  provider.rb               # Base provider class
  provider/
    registry.rb             # Defines available providers by concept
    exchange_rate_concept.rb  # Interface required for the exchange rate concept
    alpha_vantage.rb        # Concrete provider implementation
```

### One-off Data

Data that doesn't fit a concept — called directly without abstraction:
```rb
Provider::Registry.get_provider(:market_data_provider)&.usage
```

### "Provided" Concerns

Domain models should not call Registry directly. Use `Provided` concerns within model namespaces:

```rb
module ExchangeRate::Provided
  extend ActiveSupport::Concern

  class_methods do
    def provider
      registry = Provider::Registry.for_concept(:exchange_rates)
      registry.get_provider(:market_data_provider)
    end

    def find_or_fetch_rate(from:, to:, date: Date.current, cache: true)
      # Implementation
    end
  end
end
```

### Concrete Provider Pattern

Each provider inherits from `Provider` and returns `with_provider_response` (a `Provider::ProviderResponse`):

```rb
class ConcreteProvider < Provider
  def fetch_some_data
    with_provider_response do
      data = nil
      raise ProviderError.new("Could not find data") if data.nil?
      data
    end
  end
end
```

`with_provider_response` automatically catches provider errors, so implementations should raise when valid data is not possible.
