---
description: Debt optimization strategy patterns - Smith Manoeuvre, HELOC optimization, CRA compliance
globs:
  - "**/{models,services,calculators}/**/*.rb"
  - "app/components/debt*.rb"
  - "app/components/loan*.rb"
alwaysApply: false
---

# Debt Optimization Patterns

Canadian Modified Smith Manoeuvre debt optimization with CRA audit compliance.
Interactive simulator modeling real cash flows with jurisdiction-specific tax rules.

## Architecture Overview

Template method pattern with `AbstractDebtSimulator` base class and 3 subclasses.
The Smith simulator keeps its own loop (HELOC/readvanceable logic is too different)
but reuses the shared concerns.

```
AbstractDebtSimulator (app/services/abstract_debt_simulator.rb)
  includes MortgageRenewalSupport, LoanTermDefaults
  |
  +-- BaselineSimulator          — no optimization, regular payments only
  +-- PrepayOnlySimulator        — rental surplus prepays primary, no HELOC
  |
CanadianSmithManoeuvrSimulator (app/services/canadian_smith_manoeuvr_simulator.rb)
  includes MortgageRenewalSupport, LoanTermDefaults
  — full Modified Smith with HELOC, readvanceable, auto-stop rules
  — runs all 3 scenarios: baseline + prepay_only + modified_smith
```

Supporting models:
- `DebtOptimizationStrategy` — orchestration model, factory, summary metrics
- `DebtOptimizationLedgerEntry` — month-by-month simulation output
- `DebtOptimizationStrategy::AutoStopRule` — configurable stop conditions
- `DebtOptimizationStrategy::ChartSeriesBuilder` — D3 chart data
- `DebtOptimizationStrategy::AuditTrail` — CRA compliance reporting
- `CanadianMortgage` — semi-annual compounding math

---

## DebtOptimizationStrategy Model

Orchestrates simulation. Uses string-backed enums, not integers.

```ruby
# app/models/debt_optimization_strategy.rb
class DebtOptimizationStrategy < ApplicationRecord
  belongs_to :family
  belongs_to :jurisdiction, optional: true
  belongs_to :primary_mortgage, class_name: "Account", optional: true
  belongs_to :heloc, class_name: "Account", optional: true
  belongs_to :rental_mortgage, class_name: "Account", optional: true

  has_many :ledger_entries, class_name: "DebtOptimizationLedgerEntry", dependent: :destroy
  has_many :auto_stop_rules, class_name: "DebtOptimizationStrategy::AutoStopRule", dependent: :destroy

  enum :strategy_type, { baseline: "baseline", modified_smith: "modified_smith" }
  enum :status, { draft: "draft", simulated: "simulated", active: "active", completed: "completed" }

  # Factory — returns appropriate simulator
  def simulator
    case strategy_type
    when "baseline"    then BaselineSimulator.new(self)
    when "modified_smith" then CanadianSmithManoeuvrSimulator.new(self)
    end
  end
end
```

Entry point for running a simulation:

```ruby
strategy.run_simulation!  # wraps in transaction, clears old entries,
                          # calls simulator.simulate!, calculates summary metrics
```

Query helpers: `baseline_entries`, `strategy_entries`, `prepay_only_entries`.

Tax rate: `effective_marginal_tax_rate` resolves combined federal + provincial rate
via `effective_jurisdiction.combined_marginal_rate(income:, province:)`.
Falls back to `BigDecimal("0.4")` if unavailable.

---

## Simulation API

All simulators expose a single no-argument method:

```ruby
def simulate!  # AbstractDebtSimulator / CanadianSmithManoeuvrSimulator
```

The `CanadianSmithManoeuvrSimulator#simulate!` runs all 3 scenarios in sequence:

```ruby
def simulate!
  BaselineSimulator.new(strategy).simulate!
  PrepayOnlySimulator.new(strategy).simulate!
  simulate_modified_smith!
end
```

The base class loop: iterate `strategy.simulation_months` times, compute interest
via `CanadianMortgage.monthly_interest`, apply the template method
`calculate_prepayment`, bulk-insert entries with `DebtOptimizationLedgerEntry.insert_all`.

Template methods overridden by subclasses:
- `scenario_type` — `"baseline"`, `"prepay_only"`, or `"modified_smith"`
- `calculate_prepayment(rental_surplus, primary_balance, remaining_privilege)` — returns prepayment amount

---

## Shared Concerns

### LoanTermDefaults (`app/services/concerns/loan_term_defaults.rb`)

Constants and helpers used by all simulators:

```ruby
DEFAULT_MORTGAGE_RATE   = 0.05      # 5% annual
DEFAULT_HELOC_RATE      = 0.07      # 7% annual
DEFAULT_TERM_MONTHS     = 300       # 25 years
DEFAULT_HELOC_LIMIT     = 100_000   # $100K
READVANCEABLE_MAX_RATIO = 0.8       # 80% of original primary balance
```

Key methods: `primary_mortgage_rate`, `rental_mortgage_rate`, `primary_mortgage_term`,
`rental_mortgage_term`, `calculate_privilege_limit`, `calculate_mortgage_payment`.

### MortgageRenewalSupport (`app/services/concerns/mortgage_renewal_support.rb`)

Periodic mortgage renewals every N months (default 60 = 5-year Canadian term):

```ruby
def should_renew_primary?(month_index)
  # Checks loan.canadian_mortgage? and loan.renewal_term_months
  term > 0 && month_index > 0 && (month_index % term).zero?
end

def primary_renewal_rate
  # Returns loan.renewal_rate or falls back to current rate
end
```

---

## HELOC Cash Flow Waterfall

The Modified Smith loop in `CanadianSmithManoeuvrSimulator` follows this order each month:

1. **HELOC draws rental expenses** — creates deductible interest
2. **Rental income pays HELOC interest first** — `heloc_interest_from_rental`
3. **Remaining rental income prepays primary mortgage** — non-deductible debt reduction
4. **Readvanceable HELOC limit grows** as primary principal is repaid

Key state tracked in `SimulationState` Struct (keyword_init):
- Balances: `primary_balance`, `rental_balance`, `heloc_balance`, `heloc_credit_limit`
- Cumulatives: `cumulative_tax_benefit`, `cumulative_heloc_interest`
- Annual tracking: `annual_prepayment_total`, `current_year`
- Auto-stop: `strategy_stopped`, `stop_reason`
- Baseline reference: `baseline_entries_hash` (for net benefit comparison)

---

## Prepayment Privilege Limits

Annual prepayment tracking resets at each calendar year boundary:

```ruby
# In AbstractDebtSimulator and CanadianSmithManoeuvrSimulator
if current_year != calendar_month.year
  annual_prepayment_total = 0
  current_year = calendar_month.year
end

privilege_limit = calculate_privilege_limit  # from LoanTermDefaults
remaining_privilege = [privilege_limit - annual_prepayment_total, 0].max
prepayment = [raw_prepayment, primary_balance, remaining_privilege].min
```

`calculate_privilege_limit` reads `loan.prepayment_privilege_percent` and
returns `initial_primary_mortgage_balance * percent / 100`. Returns `Float::INFINITY`
if no privilege percent is set.

---

## Auto-Stop Rules

`DebtOptimizationStrategy::AutoStopRule` (`app/models/debt_optimization_strategy/auto_stop_rule.rb`)

String-backed enum with 11 rule types:

| Rule Type | What It Checks |
|-----------|---------------|
| `heloc_limit_percentage` | HELOC balance >= X% of credit limit |
| `heloc_balance_threshold` | HELOC balance >= $X |
| `primary_paid_off` | Primary mortgage balance <= 0 |
| `all_debt_paid_off` | Total debt <= 0 |
| `max_months` | Month number >= X |
| `negative_cash_flow` | Net rental cash flow < 0 |
| `heloc_interest_exceeds_benefit` | Monthly HELOC interest > tax benefit |
| `cumulative_cost_exceeds_benefit` | Cumulative net benefit < 0 (from metadata) |
| `heloc_interest_ceiling` | Monthly HELOC interest >= $X |
| `tax_refund_coverage_ratio` | Tax benefit / HELOC interest < X% |
| `manual_stop_date` | Calendar month >= stop date |

Checked via `strategy.check_auto_stop_rules(ledger_entry)` which returns
`{ triggered: true/false, rule: rule }`.

---

## Net Economic Benefit

Calculated in `DebtOptimizationStrategy#calculate_summary_metrics!` using SQL SUM:

```
net_benefit = (baseline_mortgage_interest - strategy_mortgage_interest)
            + total_tax_benefit
            - strategy_heloc_interest
```

Stored on strategy as `total_interest_saved`, `total_tax_benefit`, `net_benefit`,
and `months_accelerated`.

---

## Canadian Mortgage Math

`CanadianMortgage` (`app/models/canadian_mortgage.rb`) provides all mortgage calculations.

Semi-annual compounding per the Interest Act (R.S.C., 1985, c. I-15, s. 6):

```ruby
# Fixed-rate mortgages — semi-annual compounding
CanadianMortgage.monthly_rate(annual_rate)
# => (1 + annual_rate / 2.0) ** (1.0 / 6) - 1

# HELOCs / variable-rate — simple monthly compounding
CanadianMortgage.monthly_rate_simple(annual_rate)
# => annual_rate / 12.0

# Monthly payment (amortization formula with semi-annual rate)
CanadianMortgage.monthly_payment(principal, annual_rate, term_months)

# Monthly interest on a balance
CanadianMortgage.monthly_interest(balance, annual_rate)        # semi-annual
CanadianMortgage.monthly_interest_simple(balance, annual_rate) # monthly (HELOC)
```

---

## Anti-Patterns — DO NOT

- **DO NOT** call `simulator.run(months:)` — the actual API is `simulator.simulate!` (no arguments)
- **DO NOT** use integer-backed enums — `strategy_type` and `status` are string-backed
- **DO NOT** reference `TaxCalculatorConfig` — use `JurisdictionAware` concern with `marginal_tax_rate(income:)` or `strategy.effective_marginal_tax_rate`
- **DO NOT** use `Projectable` concern on Account — use `Account::ProjectionFacade` instead
- **DO NOT** put debt simulators in `app/models/` — they live in `app/services/` (exception to Convention 2)
- **DO NOT** add new concerns to `AbstractDebtSimulator` — prefer methods in `LoanTermDefaults` or `MortgageRenewalSupport`
- **DO NOT** use US monthly compounding (`rate / 12`) for Canadian fixed-rate mortgages — always use `CanadianMortgage.monthly_rate`
